//@version=6
indicator('Trendilo', overlay=false)
src = input(close, title='Source')
smooth = input.int(1, title='Smoothing', minval=1)
length = input.int(50, title='Lookback', minval=1)
offset = input.float(0.85, title='ALMA Offset', step=0.01)
sigma = input.int(6, title='ALMA Sigma', minval=0)
bmult = input(1.0, 'Band Multiplier')
cblen = input(false, 'Custom Band Length ? (Else same as Lookback)')
blen = input(20, 'Custom Band Length')
highlight = input(true)
fill = input(true)
barcol = input(false, 'Bar Color')
pch = ta.change(src, smooth) / src * 100
avpch = ta.alma(pch, length, offset, sigma)
blength = cblen ? blen : length
rms = bmult * math.sqrt(math.sum(avpch * avpch, blength) / blength)
cdir = avpch > rms ? 1 : avpch < -rms ? -1 : 0
col = cdir == 1 ? color.lime : cdir == -1 ? color.red : color.gray
// Notification logic
var int last_cdir = na
if not na(cdir) and cdir != last_cdir
	if cdir == 1
		alert('Trendilo: Trend turned GREEN', alert.freq_once_per_bar)
	if cdir == -1
		alert('Trendilo: Trend turned RED', alert.freq_once_per_bar)
	last_cdir := cdir
fplot = plot(avpch, color=highlight ? col : color.blue, linewidth=2)
posrms = plot(rms, color=color.new(color.purple, 0))
negrms = plot(-rms, color=color.new(color.purple, 0))
fill(fplot, posrms, color=fill and cdir > 0 ? col : na)
fill(fplot, negrms, color=fill and cdir < 0 ? col : na)
barcolor(color=barcol ? col : na)
hline(0)

// Show label when avpch touches 0 line
touches_zero = math.abs(avpch) < 0.0001
if touches_zero
	label.new(x=bar_index, y=0, text="NO GO ZONE", color=color.gray, style=label.style_label_down, size=size.small)

